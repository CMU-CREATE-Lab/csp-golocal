<div class="csp-header text-center">
  <div class="csp-header-buttons">
  </div>
  <h2 class="text-center"><a href="/">CSP GoLocal</a></h2>
</div>

<p style="color: green"><%= notice %></p>

<div class="container px-4">
  <h2>Find A Restaurant</h2>
  <br/>
  <h4>Filter Options</h4>
  <div class="csp-search-keywords">
    <% @filter_keywords_to_display.each do |keyword, display| %>
    <a href="#"><span value="<%= keyword %>" class="badge"><%= display %></span></a>
    <% end %>
  </div>
  <br/>
</div>
<br/>
<div class="container px-4">
  <div id="business-list" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 gx-5 gy-5">
    <!-- script: populateViews() -->
  </div>
</div>


<br/>
<br/>
<hr>
<hr>
<hr>
<br/>
<br/>

<%= link_to "Create new", new_temp_business_path %>


<script>

var js_businesses = <%= raw @js_businesses %>;
var js_filter_keywords_to_display = <%= raw @js_filter_keywords_to_display %>;


function createDivForBusiness(business) {
  // see "Creating New Elements": https://api.jquery.com/jQuery/#jQuery2
  var divCol = $("<div class=\"col\" />");
  var aLink = $('<a style="display:block; color: inherit; text-decoration: inherit;" href="'+business.link+'" />');
  var div2 = $('<div class="p-3 border bg-light" />');
  var img = $('<img src="'+business.logo+'" alt="foobar" style="width:100%; height:250px; object-fit: cover;" />');
  var h3 = $('<h3>'+business.name+'</h3>');
  var divKeywords = $('<div class="csp-keywords" />');

  var listSpans = business.keywords.map( function(item) {
    var display = js_filter_keywords_to_display[item];
    return $('<span value="'+this+'" class="badge">'+display+'</span>');
  });

  // construction
  listSpans.forEach(function(item) {
    divKeywords.append(item);
  });
  div2.append(img);
  div2.append(h3);
  div2.append(divKeywords);
  aLink.append(div2);
  divCol.append(aLink);

  return divCol;
}


function businessListClear() {
  $("#business-list").children().remove();
}


function businessListAppend(jsonArray) {
  jsonArray.forEach(function(item) {
    // TODO call createDivForBusiness only once?
    $("#business-list").append( createDivForBusiness(item) );
  });
}


function populateViews(list) {
  businessListClear();
  businessListAppend(list);
}


window.onload = function () {
  $("div.csp-search-keywords a").on("click", function(event) {
    var target = event.target;
    $(target).toggleClass("keywords-selected");
    //console.log("Toggle keyword: " + target.textContent + ", value=" + $(target).attr("value"));
    populateViews(js_businesses.sort(generateSortFunction( generateListOfKeywordsSelected() )));
  });

  // ASSERT: no filters selected on page load
  populateViews(js_businesses);
};


// -- TODO test functions (integrate and delete later)

function intersectArray(array1, array2) {
  // https://stackoverflow.com/questions/1885557/simplest-code-for-array-intersection-in-javascript
  return array1.filter(value => array2.includes(value));
}

function generateSortFunction(keywords) {
  return (function(a, b) {
    // #-matching-keywords in descending order
    var s1 = (intersectArray(keywords, b.keywords).length - intersectArray(keywords, a.keywords).length);
    // Name in ascending order (i.e. A-Z)
    var s2 = a.name.localeCompare(b.name);
    return (2 * s1) + s2;
  });
}

function generateListOfKeywordsSelected() {
  // https://api.jquery.com/map/
  return $("div.csp-search-keywords span.keywords-selected").map(function() {
    return $(this).attr("value");
  }).get();
}

// list = [ "offers_delivery", "offers_catering" ];
// blist = [ js_businesses[0], js_businesses[1], js_businesses[2], js_businesses[3] ];
// var listOfKeywords = $("div.csp-search-keywords span.keywords-selected").map(function() {
//   return $(this).attr("value");
// }).get();

// -- ...

</script>
